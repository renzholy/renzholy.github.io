{"pageProps":{"lastModified":"Sun, 26 Jun 2022 12:13:32 GMT","data":"# WASM è¾“å…¥ä¸è¾“å‡º\n\n## WASM ç®€ä»‹\n\nWASMï¼ˆWebAssemblyï¼‰æ˜¯ä¸€ç§ç”¨äºå †æ ˆå¼è™šæ‹Ÿæœºçš„äºŒè¿›åˆ¶æŒ‡ä»¤æ ¼å¼ã€‚å®ƒæ˜¯æ˜¯ä¸€ç§æ–‡ä»¶æ ¼å¼æ ‡å‡†ï¼Œä¸æ˜¯ç‰¹å®šçš„è™šæ‹Ÿæœºå®ç°ï¼Œå› æ­¤æœ‰å„ç§ compilerã€interpreter ä»¥åŠ runtimeï¼Œå¦‚[wastime](https://github.com/bytecodealliance/wasmtime)ã€[Wasmer](https://wasmer.io/)ã€[V8](https://v8.dev/docs/wasm-compilation-pipeline)ã€ [Lucet](https://github.com/bytecodealliance/lucet/)ã€[WAMR](https://github.com/bytecodealliance/wasm-micro-runtime)ã€[wasm3](https://github.com/wasm3/wasm3/)ã€‚\n\nWASM åœ¨è®¾è®¡ä¹‹åˆï¼Œè€ƒè™‘äº†ä»¥ä¸‹å‡ ç‚¹ï¼š[ğŸ”—](https://webassembly.org/)\n\n- **é«˜æ•ˆå’Œå¿«é€Ÿ**ï¼šä½“ç§¯å°ï¼ŒåŠ è½½é€Ÿåº¦å¿«ã€‚å¯ä»¥æµå¼åŠ è½½ï¼Œè¾¹ä¸‹è½½è¾¹åˆå§‹åŒ–ï¼Œå‡å°‘æ—¶é—´å’Œå†…å­˜å ç”¨ã€‚ç†è®ºä¸Šå¯ä»¥è¾¾åˆ°åŸç”Ÿçš„è¿è¡Œé€Ÿåº¦ã€‚\n- **å®‰å…¨**ï¼šWASM æè¿°äº†ä¸€ä¸ªå†…å­˜å®‰å…¨çš„æ²™ç®±æ‰§è¡Œç¯å¢ƒï¼Œç”šè‡³å¯ä»¥åœ¨ç°æœ‰çš„ JavaScript è™šæ‹Ÿæœºä¸­å®ç°ã€‚\n- **å¼€æ”¾å¯è°ƒè¯•**ï¼šå¯ä»¥ç¿»è¯‘ä¸ºå¯è¯»çš„æ–‡æœ¬æ ¼å¼`.wat`ï¼ˆå¯ä»¥ç†è§£ä¸º WASM å¹³å°çš„æ±‡ç¼–è¯­è¨€ï¼‰ï¼Œé…åˆ source map æ–¹ä¾¿è°ƒè¯•ã€‚\n- **Web æ ‡å‡†**ï¼šæ¨¡å—èƒ½å¤Ÿä¼ å…¥å’Œä¼ å‡º JavaScript ä¸Šä¸‹æ–‡ï¼Œå¹¶é€šè¿‡ JavaScript è®¿é—® Web API æ¥è®¿é—®æµè§ˆå™¨åŠŸèƒ½ã€‚åŒæ—¶ä¹Ÿ**æ”¯æŒéæµè§ˆå™¨ç¯å¢ƒä¸­è¿è¡Œ**ã€‚\n\nä½†ä¹Ÿæœ‰ä»¥ä¸‹é™åˆ¶ï¼š\n\n- åŸºç¡€æ•°æ®ç±»å‹åªæœ‰ i32ã€i64ã€f32ã€f64ã€‚é«˜çº§æ•°æ®ç»“æ„ï¼ˆå¦‚ï¼šå­—ç¬¦ä¸²ï¼‰æ¯ç§è¯­è¨€éœ€è¦è‡ªå·±å®ç°ã€‚[ğŸ”—](https://www.assemblyscript.org/memory.html#internals)\n- åªèƒ½è¿›è¡ŒåŒæ­¥è®¡ç®—ï¼Œä¸æ”¯æŒå¼‚æ­¥å‡½æ•°ã€‚\n- å¯¹äº Goã€Python è¿™ç§å¸¦è¿è¡Œæ—¶çš„è¯­è¨€ç¼–è¯‘åˆ° WASMï¼Œéœ€è¦å°†è¿è¡Œæ—¶ä¸€èµ·æ‰“åŒ…ï¼Œç”Ÿæˆçš„æ–‡ä»¶ä½“ç§¯è¾ƒå¤§ã€‚\n\næ¥ä¸‹æ¥æˆ‘ä»¬å°†ä½¿ç”¨ Node.jsï¼ˆV8ï¼‰ä½œä¸º runtime è¯­è¨€ï¼ŒAssemblyScript ä½œä¸ºç¼–è¯‘åˆ° WASM çš„è¯­è¨€ï¼Œæ¥åšç‚¹å®éªŒã€‚\n\n## AssemblyScript\n\n> A language made for WebAssembly.\n\nå¯¹äºå¾ˆå¤šåœ¨ WASM è¯ç”Ÿå‰å°±å·²ç»å­˜åœ¨çš„è¯­è¨€ï¼ŒWASM å°±åƒ x86ã€ARM64 ä¸€æ ·ï¼Œåªæ˜¯ä¸€ç§æ–°çš„ platform targetã€‚\n\nè€Œ AssemblyScript æ˜¯ä¸€ä¸ªä¸º WASM è€Œç”Ÿçš„è¯­è¨€ï¼Œç›®å‰åªèƒ½ç¼–è¯‘åˆ° WASMã€‚å®ƒçš„è¯­æ³•æ˜¯ä¸€ç§ TypeScript çš„å˜ä½“ï¼Œä½†å®é™…å†™èµ·æ¥æ—¶ï¼Œæœ‰æ—¶å´è¦åƒå†™ C è¯­è¨€é‚£æ ·æ€è€ƒã€‚\n\nAssemblyScript é¡¹ç›®æ­å»ºè¯·å‚è€ƒ[Quick Start](https://www.assemblyscript.org/quick-start.html)ã€‚\n\n## a+b\n\næˆ‘ä»¬æ¥å†™ä¸€ä¸ªç®€å•çš„ a+bï¼Œä¸ºä»€ä¹ˆä¸æ˜¯ hello worldï¼Ÿå› ä¸ºå­—ç¬¦ä¸²åœ¨ WASM é‡Œæ˜¯é«˜çº§æ•°æ®ç»“æ„ã€‚æˆ‘ä»¬å…ˆä»æœ€ç®€å•çš„ i32 å¼€å§‹ï¼š\n\n```typescript\n// sum.ts\nexport function sum(a: i32, b: i32): i32 {\n  return a + b;\n}\n```\n\nç¼–è¯‘åå¾—åˆ°ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶`sum.wasm`ï¼Œå’Œä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶`sum.wat`ã€‚ä¸¤è€…å¯ä»¥ä½¿ç”¨[wabt](https://github.com/WebAssembly/wabt)äº’ç›¸è½¬æ¢ã€‚æˆ‘ä»¬ä»¥æ–‡æœ¬æ ¼å¼ä¸ºä¾‹ï¼š\n\n```clojure\n; sum.wat\n(module\n  (type $t0 (func (param i32 i32) (result i32)))\n  (func $sum (type $t0) (param $p0 i32) (param $p1 i32) (result i32)\n    local.get $p0\n    local.get $p1\n    i32.add)\n  (memory $memory 0)\n  (export \"sum\" (func $sum))\n  (export \"memory\" (memory 0)))\n```\n\nå¦‚æœå­¦è¿‡æ±‡ç¼–ï¼Œä¸äº†è§£ WAT è¯­æ³•ä¹Ÿå¯ä»¥çœ‹æ‡‚ä¸ªå¤§æ¦‚ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯`export \"memory\"`ï¼Œè¿™æ˜¯ WSAM æŠŠå†…å­˜æš´éœ²ç»™ runtimeï¼Œåé¢çš„ä¾‹å­ä¼šç”¨åˆ°ã€‚\n\næ¥ä¸‹æ¥åœ¨ Node.js ä¸­è°ƒç”¨ï¼š\n\n```typescript\nimport fs from \"fs\";\n\nconst file = await fs.promises.readFile(\"./sum.wasm\");\nconst module = new WebAssembly.Module(file);\nconst instance = new WebAssembly.Instance(module);\n\nconsole.log((instance.exports.sum as Function)(1, 2));\n// stdout: 3\n```\n\nåªéœ€å‡ è¡Œä»£ç å°±å®Œæˆäº†è°ƒç”¨ï¼Œå¹¶è¾“å‡ºäº†é¢„æœŸçš„ç»“æœã€‚\n\n## 'hello, world!'\n\næ¥çœ‹çœ‹å­—ç¬¦ä¸²æ˜¯å¦‚ä½•åœ¨ WASM ä¸ runtime ä¹‹é—´ä¼ é€’çš„ã€‚\n\n```typescript\n// hello-world.ts\nexport function hello_world(): string {\n  return `hello, world!`;\n}\n```\n\nç¼–è¯‘åå¾—åˆ°ï¼š\n\n```clojure\n; hello-world.wat\n(module\n  (type $t0 (func (result i32)))\n  (func $hello_world (type $t0) (result i32)\n    i32.const 1056)\n  (memory $memory 1)\n  (export \"hello_world\" (func $hello_world))\n  (export \"memory\" (memory 0))\n  (data $d0 (i32.const 1036) \",\")\n  (data $d1 (i32.const 1048) \"\\01\\00\\00\\00\\1a\\00\\00\\00h\\00e\\00l\\00l\\00o\\00,\\00 \\00w\\00o\\00r\\00l\\00d\\00!\"))\n```\n\nåœ¨ Node.js ä¸­è°ƒç”¨ï¼š\n\n```typescript\nimport fs from \"fs\";\n\nconst file = await fs.promises.readFile(\"./hello-world.wasm\");\nconst module = new WebAssembly.Module(file);\nconst instance = new WebAssembly.Instance(module);\n\nconsole.log((instance.exports.hello_world as Function)());\n// stdout: 1056\n```\n\nç»“æœä¸æ˜¯\"hello, world!\"ï¼Œè€Œæ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå‘ç”Ÿä»€ä¹ˆäº‹äº†ï¼Ÿ\n\nè¿™ä¸ªæ•°å­—å…¶å®æ˜¯ä¸€ä¸ªæŒ‡é’ˆçš„åœ°å€ï¼Œå®ƒæŒ‡å‘äº†ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚é€šè¿‡[string-layout](https://www.assemblyscript.org/memory.html#string-layout)è¿™ç¯‡æ–‡æ¡£ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ AssemblyScript çš„å­—ç¬¦ä¸²æ˜¯å¦‚ä½•åœ¨å†…å­˜ä¸­æ’å¸ƒçš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç¼–å†™ä»£ç æŠŠå­—ç¬¦ä¸²å–å‡ºæ¥ã€‚\n\n```typescript\n// ...\nconst offset = (instance.exports.hello_world as Function)();\nconst memory = instance.exports.memory as WebAssembly.Memory;\nconst buffer = Buffer.from(memory.buffer);\nconst len = buffer.readUInt32LE(offset - 4);\n\nconsole.log(buffer.slice(offset, offset + len).toString());\n// stdout: hello, world!\n```\n\nWASM ä½¿ç”¨çš„æ˜¯[little endian byte order](https://webassembly.github.io/spec/core/syntax/instructions.html#memory-instructions)ï¼Œå› æ­¤æˆ‘ä»¬ç”¨`readUInt32LE`è€Œä¸æ˜¯`readUInt32BE`ã€‚\n\n## \\`hello, ${str}!\\`\n\næˆ‘ä»¬å·²ç»å­¦ä¼šæŠŠå­—ç¬¦ä¸²ä» WASM ä¼ åˆ° runtime ä¸­ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å­¦ä¹ åå‘æ“ä½œã€‚\n\n```typescript\n// hello.ts\nexport function hello(str: string): string {\n  return `hello, ${str}!`;\n}\n```\n\nä½¿ç”¨ç¼–è¯‘å‚æ•°ï¼š\n\n```bash\nasc hello.ts --use abort= --target release\n```\n\næˆ‘ä»¬åªæ”¹äº†å‡ ä¸ªå­—ç¬¦ï¼Œä½†è¿™æ¬¡ç¼–è¯‘å‡ºçš„ hello.wat å·²ç»æœ‰ 400+è¡Œã€‚\n\nåœ¨å‰ä¸¤ä¸ªä¾‹å­ä¸­ï¼Œå†…å­˜æ˜¯é™æ€çš„ï¼Œè€Œåœ¨è¿™ä¸ªä¾‹å­é‡Œæˆ‘ä»¬è¿›è¡Œäº†å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå°±æ¶‰åŠåˆ°äº†å†…å­˜çš„åŠ¨æ€ç®¡ç†ã€‚å› æ­¤ AssemblyScript éœ€è¦æŠŠå†…å­˜å›æ”¶è¿è¡Œæ—¶æ‰“åŒ…è¿› WASMï¼Œå°±å¢åŠ äº†æ–‡ä»¶ä½“ç§¯ã€‚\n\n```typescript\n// ...\nconst memory = instance.exports.memory as WebAssembly.Memory;\nconst buffer = Buffer.from(memory.buffer);\nconst str = \"wasm\";\nconst ptr = 1024;\nbuffer.writeUInt32LE(str.length, ptr - 4);\nBuffer.from(str).copy(buffer, ptr);\nconst offset = (instance.exports.hello as Function)(ptr);\nconst len = buffer.readUInt32LE(offset - 4);\n\nconsole.log(buffer.slice(offset, offset + len).toString());\n// stdout: hello, wasm!\n```\n\nè¿™é‡Œçš„`ptr = 1024`æ˜¯ä¸€ä¸ªå±é™©çš„åšæ³•ï¼Œè¿™ä¸ªä¾‹å­é‡Œæˆ‘ä»¬å‡å®š WASM ä¸ä¼šä½¿ç”¨ç¬¬ 1024 ä¸ªå­—èŠ‚é™„è¿‘çš„å†…å­˜ï¼Œå®é™…ä½¿ç”¨ä¸­ä¸èƒ½è¿™ä¹ˆå†™ï¼Œè¿™æ ·å¯èƒ½ä¼šè¦†ç›–æ‰ WASM æ‰€éœ€è¦çš„æ•°æ®ï¼Œä½¿ WASM è¿è¡Œå¼‚å¸¸ã€‚\n\nAssemblyScript æä¾›äº†[Loader](https://www.assemblyscript.org/loader.html#loader)ï¼Œå°è£…äº†è¿™ç§é«˜çº§æ•°æ®ç»“æ„ä¼ é€’çš„æ–¹æ³•ï¼›Rust ä¹Ÿæä¾›äº†[wasm-bingen](https://github.com/rustwasm/wasm-bindgen)ï¼Œå¯ä»¥ç”Ÿæˆ`.js`å’Œ`.d.ts`æ–‡ä»¶ï¼Œåœ¨ js ä»£ç ä¸­ç›´æ¥ import å°±å¯ä»¥è°ƒç”¨ Rust ç¼–å†™çš„ WASM æ¨¡å—ä¸­çš„å‡½æ•°ã€‚\n\nåˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä½ å¯¹å¦‚ä½•åœ¨ WASM ä¸ runtime ä¹‹é—´ä¼ é€’æ•°æ®å·²ç»æœ‰äº†åˆæ­¥äº†è§£ã€‚\n","pathname":"wasm/è¾“å…¥ä¸è¾“å‡º"},"__N_SSG":true}